<template>
  <v-tabs v-model="tab" show-arrows center-active grow class="transparent">
    <v-tab> 홈 </v-tab>
    <v-tab> 글 쓰기 </v-tab>
    <v-tab v-if="classInfo.uid === userInfo.uid"> 설정 </v-tab>

    <v-tabs-items v-model="tab" class="py-5 transparent">
      <v-tab-item class="pt-10">
        <h1 class="primary--text" v-text="classInfo.name" />
        <h4 class="grey--text">선생님 {{ classInfo.creator }}</h4>
        <p class="my-5" v-text="classInfo.description" />

        <br />

        <v-card v-for="(category, title) in classInfo.contents" :key="title" class="transparent">
          <v-card-title v-text="title" />

          <v-card
            v-for="(item, i) in category"
            v-if="item.type === '책'"
            :key="item.title"
            class="d-flex mt-5"
            :to="`/book/content/${item.time}`"
          >
            <v-icon color="orange" class="ml-4" size="40"> mdi-book </v-icon>
            <div>
              <v-card-title v-text="item.displayName" />
              <v-card-subtitle v-text="item.title" />
              <v-card-text v-text="new Date(item.time).toLocaleDateString()" />
            </div>

            <v-spacer />

            <v-card-actions>
              <v-menu v-if="userInfo.uid === item.uid" offset-y>
                <template #activator="{ on, attrs }">
                  <v-btn
                    icon
                    v-bind="attrs"
                    cols="1"
                    v-on="on"
                    @click.stop.prevent=""
                  >
                    <v-icon>mdi-dots-vertical</v-icon>
                  </v-btn>
                </template>
                <v-list>
                  <v-list-item @click="deleteContent(title, i)">
                    <v-list-item-title>
                      <v-icon left> mdi-trash-can </v-icon> 삭제
                    </v-list-item-title>
                  </v-list-item>
                </v-list>
              </v-menu>
            </v-card-actions>
          </v-card>
          <v-card
            v-else-if="item.type === '파일'"
            :href="item.url"
            class="d-flex mt-5"
          >
            <v-icon class="ml-4"> mdi-link-variant </v-icon>

            <div>
              <v-card-title>{{ item.file }}</v-card-title>
              <v-card-subtitle>{{ item.displayName }}</v-card-subtitle>
            </div>

            <v-spacer />

            <v-card-actions>
              <v-menu v-if="userInfo.uid === item.uid" offset-y>
                <template #activator="{ on, attrs }">
                  <v-btn
                    icon
                    v-bind="attrs"
                    cols="1"
                    v-on="on"
                    @click.stop.prevent=""
                  >
                    <v-icon>mdi-dots-vertical</v-icon>
                  </v-btn>
                </template>
                <v-list>
                  <v-list-item @click="deleteContent(title, i)">
                    <v-list-item-title>
                      <v-icon left> mdi-trash-can </v-icon> 삭제
                    </v-list-item-title>
                  </v-list-item>
                </v-list>
              </v-menu>
            </v-card-actions>
          </v-card>
          <v-card
            v-else-if="item.type === '링크'"
            :href="item.url"
            class="d-flex mt-5"
          >
            <v-icon class="ml-4"> mdi-link </v-icon>

            <div>
              <v-card-title>{{ item.name }} 링크</v-card-title>
              <v-card-subtitle>
                <a :href="item.link" v-text="item.title" target="_blank" />
              </v-card-subtitle>
            </div>
          </v-card>
          <v-card v-else class="mt-5">
            <div class="d-flex">
              <v-avatar size="40" class="ml-3 mt-6">
                <v-img :src="item.photoURL" class="rounded-lg" />
              </v-avatar>
              <div>
                <v-card-title>{{ item.displayName }}의 공지사항</v-card-title>
                <v-card-subtitle
                  v-text="new Date(item.time).toLocaleDateString()"
                />
              </div>
              <v-spacer />
              <v-card-actions>
                <v-menu v-if="userInfo.uid === item.uid" offset-y>
                  <template #activator="{ on, attrs }">
                    <v-btn
                      icon
                      v-bind="attrs"
                      cols="1"
                      v-on="on"
                      @click.stop.prevent=""
                    >
                      <v-icon>mdi-dots-vertical</v-icon>
                    </v-btn>
                  </template>
                  <v-list>
                    <v-list-item @click="deleteContent(title, i)">
                      <v-list-item-title>
                        <v-icon left> mdi-trash-can </v-icon> 삭제
                      </v-list-item-title>
                    </v-list-item>
                  </v-list>
                </v-menu>
              </v-card-actions>
            </div>
            <v-card-text v-text="item.content" />
          </v-card>
        </v-card>
      </v-tab-item>

      <v-tab-item class="pt-10">
        <v-select
          v-model="post.type"
          :items="['책', '공지사항', '파일', '링크']"
          label="종류 선택"
          outlined
          class="mb-10"
        />

        <v-row style="gap: 10px" class="ma-10">
          <v-text-field
            v-if="classInfo.uid === userInfo.uid"
            v-model="post.category"
            label="수업 이름"
            outlined
          />
          <v-select
            v-model="post.category"
            :items="Object.keys(classInfo.contents || {})"
            label="종류 선택"
            outlined
          />
        </v-row>

        <v-card v-if="post.type === '책'">
          <v-card-title>책 링크 업로드</v-card-title>
          <v-card-text>
            <v-text-field v-model="post.title" label="제목" />

            <div v-if="post.time">
              <h2>선택됨</h2>
              <br />
              <v-img :src="post.image" max-width="200" class="rounded-lg" />
            </div>
          </v-card-text>

          <v-card-actions class="ma-2 gap20">
            <v-dialog v-model="dialog" width="700">
              <template #activator="{ on, attrs }">
                <div class="text-center">
                  <v-btn color="primary" v-bind="attrs" v-on="on">
                    <v-icon left>mdi-bookshelf</v-icon> 책 선택
                  </v-btn>
                </div>
              </template>

              <v-card>
                <v-row no-gutters>
                  <v-card
                    v-for="i in listev.filter(i => i.uid == userInfo.uid)"
                    :key="i.title"
                    @click="
                      post.time = i.time
                      post.image = i.image
                      dialog = false
                    "
                    class="elevation-0"
                  >
                    <v-img
                      :src="i.image"
                      class="rounded-lg ma-3"
                      max-width="100"
                    />
                  </v-card>
                </v-row>
              </v-card>
            </v-dialog>

            <v-spacer />

            <v-btn
              :disabled="post.title === ''"
              color="primary"
              class="elevation-0"
              @click="postcontent"
            >
              게시
            </v-btn>
          </v-card-actions>
        </v-card>
        <v-card v-else-if="post.type === '링크'" class="transparent">
          <v-card-title>링크 업로드</v-card-title>
          <v-card-text>
            <v-text-field v-model="post.title" label="제목" />
            <v-text-field v-model="post.link" label="링크" />
          </v-card-text>
          <v-card-actions class="ma-2 gap20">
            <v-btn
              :disabled="post.title === ''"
              color="primary"
              class="elevation-0"
              @click="postcontent"
            >
              게시
            </v-btn>
          </v-card-actions>
        </v-card>
        <v-card v-else-if="post.type === '파일'" class="transparent">
          <v-progress-linear
            v-if="progress > 0"
            color="primary"
            :value="progress"
          />

          <v-file-input
            v-model="post.file"
            color="deep-purple accent-4"
            counter
            label="File input"
            multiple
            placeholder="Select your files"
            prepend-icon="mdi-paperclip"
            outlined
            :show-size="1000"
            ref="file"
            @change="f => (post.file = f)"
          >
            <template v-slot:selection="{ index, text }">
              <v-chip
                v-if="index < 2"
                color="deep-purple accent-4"
                dark
                label
                small
              >
                {{ text }}
              </v-chip>

              <span
                v-else-if="index === 2"
                class="text-overline grey--text text--darken-3 mx-2"
              >
                +{{ files.length - 2 }} File(s)
              </span>
            </template>
          </v-file-input>
          <v-btn color="primary" @click="upload">
            <v-icon left>mdi-file-upload</v-icon>
            파일 게시
          </v-btn>
        </v-card>
        <LazyCommentComponent
          v-else
          :link="`/class/${id}`"
          :dbr="`classes/${id}/contents/${post.category}`"
          :nocomments="true"
          :cb="() => (tab = 0)"
          :uid="userInfo.uid"
        />
      </v-tab-item>

      <v-tab-item v-if="classInfo.uid === userInfo.uid" class="pt-10">
        <v-card class="mt-5">
          <v-card-title>수업 세부정보</v-card-title>
          <v-card-text>
            <v-text-field v-model="classInfo.name" label="수업 이름" required />
            <v-textarea
              v-model="classInfo.description"
              label="수업 설명"
              required
            />
            <v-checkbox
              v-model="classInfo.public"
              label="수업 전체 공개 여부"
              required
            />
            <v-btn
              color="primary"
              class="mt-5"
              :disabled="!classInfo.name || !classInfo.description"
              @click="updateClass"
            >
              수업 정보 수정
            </v-btn>
          </v-card-text>
        </v-card>
        <v-card class="mt-5">
          <v-card-title>삭제</v-card-title>
          <v-card-text>
            <LazyDialogComponent
              :cb="deleteClass"
              btn-title="삭제"
              title="진짜로 삭제하겠습니까?"
              text="삭제하면 복구할 수 없습니다"
              icon="trash-can"
            />
          </v-card-text>
        </v-card>
      </v-tab-item>
    </v-tabs-items>
  </v-tabs>
</template>

<script>
import { db, storage } from '@/plugins/firebase'

export default {
  asyncData({ params }) {
    const id = params.class
    return { id }
  },
  data() {
    return {
      classInfo: {
        contents: [],
        users: []
      },
      listev: [],
      post: {
        title: '',
        link: '',
        time: Date.now(),
        category: '',
        file: [],
        type: '책'
      },

      dialog: false,
      tab: 0,
      progress: 0
    }
  },
  created() {
    db.ref(`/classes/${this.id}`).on(
      'value',
      async s => (this.classInfo = await s.val())
    )

    db.ref('/contents/').on('child_added', s => {
      const { title, time, uid, displayName, image } = s.val()

      this.listev.unshift({
        title,
        time,
        uid,
        displayName,
        image
      })
    })
  },
  methods: {
    upload() {
      let storageRef

      for (let i = 0; i < this.post.file.length; i++) {
        storageRef = storage
          .ref(`${this.post.file[i].name}`)
          .put(this.post.file[i])
      }

      storageRef.on(
        `state_changed`,
        s => (this.progress = (s.bytesTransferred / s.totalBytes) * 100),
        e => console.log(e.message),
        () =>
          storageRef.snapshot.ref
            .getDownloadURL()
            .then(url => {
              const { type, file, category } = this.post
              const { uid, displayName } = this.userInfo

              db.ref(`classes/${this.id}/contents/${category}`).push({
                type,
                uid,
                displayName,
                url,
                file: file[0].name
              })
            })
            .then(() => {
              this.tab = 0
              this.post.title = ''
              this.post.time = ''
              this.post.file = []
              this.post.book = true
              this.post.type = '책'
              this.progress = 0
            })
      )
    },
    updateClass() {
      db.ref(`/classes/${this.id}`).update(this.classInfo)
      this.tab = 0
    },
    deleteContent(title, i) {
      delete this.classInfo.contents[i]
      db.ref(`/classes/${this.id}/contents/${title}/${i}`).remove()
    },
    postcontent() {
      const { title, time, category, type, link } = this.post
      const { uid, displayName } = this.userInfo

      db.ref(`/classes/${this.id}/contents/${category}`).push({
        title,
        uid,
        time,
        displayName,
        type,
        link
      })

      this.post = {}
      this.tab = 0
    },
    deleteClass() {
      db.ref('classes').child(this.id).remove()
      this.$router.push('/classes')
    }
  }
}
</script>

<style scoped>
.gap20 {
  gap: 20px;
}
</style>
